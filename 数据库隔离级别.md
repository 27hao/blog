---
title: 数据库事务隔离级别
categories: 数据库
date: 2019-03-14 17:09:43
---

数据库隔离级别是相伴与数据库事务产生的概念，虽然用到和接触到的地方不多，但是有时候在遇到事务问题后，往往会忽略掉隔离级别这个问题；所以在这里详细解释一下数据库隔离级别。

### 数据库事务
事务（Transaction）是并发控制的基本单位。所谓的事务，它是一个操作序列，这些操作要么都执行，要么都不执行，它是一个不可分割的工作单位。例如，银行转账工作：从一个账号扣款并使另一个账号增款，这两个操作要么都执行，要么都不执行。所以，应该把它们看成一个事务。事务是数据库维护数据一致性的单位，在每个事务结束时，都能保 持数据一致性。
事务的四个特性（ACID）：
* 原子性：事务作为一个整体被执行，包含在其中的对数据库的操作要么全部被执行，要么都不执行。
* 一致性：事务应确保数据库的状态从一个一致状态转变为另一个一致状态。一致状态的含义是数据库中的数据应满足完整性约束。
* 隔离性：多个事务并发执行时，一个事务的执行不应影响其他事务的执行
* 持久性：一个事务一旦提交，他对数据库的修改应该永久保存在数据库中。

### 数据库隔离级别
一般数据库有四个隔离级别，不同的隔离级别会对事务的操作产生不同的效果；关于事务隔离级别及其作用，我们在后面的章节中会进行详细介绍，这里只要简单知道数据库可以设置不同的事务隔离级别即可。
数据库的四个隔离级别：
1. 读未提交数据
2. 读已提交数据
3. 可重复读
4. 串行化

使用以下命令可以查询当前Mysql会话的事务隔离级别，可以看到，Mysql默认的事务隔离级别是REPEATABLE-READ。
```SQL
mysql> select @@tx_isolation;
+-----------------+
| @@tx_isolation  |
+-----------------+
| REPEATABLE-READ |
+-----------------+
```
改变Mysql数据库隔离级别：
> SET [SESSION | GLOBAL] TRANSACTION ISOLATION LEVEL {READ UNCOMMITTED | READ COMMITTED | REPEATABLE READ | SERIALIZABLE}

```
mysql> set session transaction isolation level read committed;
Query OK, 0 rows affected (0.02 sec)

mysql> select @@tx_isolation;
+----------------+
| @@tx_isolation |
+----------------+
| READ-COMMITTED |
+----------------+
1 row in set (0.00 sec)
```
### 并发事务产生的问题
##### 1. 脏读，读到未提交更新的数据
|时间点|事务A|事务B|
|:---|:---:|---:|
|T1|开始事务|开始事务|
|T2||查询账户为1000元|
|T3||取出500,余额为500元|
|T4|查询账户为500元（脏读）||
|T5||撤销事务，余额变回1000|
|T6|存入100，余额改为600||
|T7|提交事务||
A事务查询到了B事务未提交的更新数据，A事务依据这个查询结果继续执行相关操作。但是接着B事务撤销了所做的更新，这会导致A事务操作的是脏数据，以上的示例中T5时刻产生了脏读，最终导致A事务提交时账户余额的不正确，可能有人会有疑问，B事务还没有提交或撤销，T5时刻A事务为什么能读到已经改变的数据，这里要说的是，数据表中的数据是实时改变的，事务只是控制数据的最终状态，也就是说如果没有正确的隔离级别，在更新操作语句结束后，即使事务未完成，其他事务就已经可以读取到改变的数据值了。
>现在为止:所有的数据库都避免脏读操，可以用两个Mysql会话试验一下以上的操作，在默认的隔离级别下（REPEATABLE-READ），A事务在T5时刻读取到的余额为1000元，不会是500元。

##### 2. 不可重复读,读到已经提交更新的数据，但一个事务范围内两个相同的查询却返回了不同数据。

|时间点|事务A|事务B|
|---|---|---|
|T1|开始事务|开始事务|
|T2||查询账户为1000元|
|T3|查询账户为1000元||
|T4||取出100,余额为900元|
|T5||提交事务|
|T6|读取余额为1000元（与T3读取的一不一致）||

##### 3. 幻读，读到已提交插入数据

|时间点|事务A|事务B|
|---|---|---|
|T1|开始事务|开始事务|
|T2|查询到账户数量为100||
|T3||增加一个账户|
|T4||提交事务|
|T6|再次统计账户数量为101|||

幻读与不可重复读类似，幻读是查询到了另一个事务已提交的新插入数据，而不可重复读是查询到了另一个事务已提交的更新数据。
